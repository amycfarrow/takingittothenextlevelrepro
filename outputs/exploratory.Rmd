---
title: "data exploration"
author: "Amy"
date: "29/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readstata13)
library(arsenal)
library(Hmisc)
library(MASS)
library(kableExtra)
library(apaTables)
```

```{r}
codebook <- read_csv(here("inputs/data/codebook.csv"))
```



```{r, warning=FALSE}
isrdata <- read.dta13(here("inputs/data/Instructor-Student Relationships Experiment Data_Anonymous.dta"))
```

```{r}
expdata <- isrdata %>%
  filter(use == 1)
```

```{r}
summary(tableby(treatment ~  s1_sim + s1_tsr + s2_sim + s2_tsr + t2_sim1 + t2_tsr + grade + std_grade + t2_finalexam + f17_enrolled + ir_f16_gpa + s_female,
                data = isrdata)) %>%
  kable()
```

```{r}
rcorr(as.matrix(isrdata %>% 
                  dplyr::select(s1_sim, s1_tsr, s2_sim, s2_tsr, t2_sim1, t2_tsr, grade, std_grade, t2_finalexam, ir_f16_gpa)))
```

```{r}
apa.cor.table(isrdata %>% 
                  dplyr::select(s1_sim, s1_tsr, s2_sim, s2_tsr, t2_sim1, t2_tsr, grade, std_grade, t2_finalexam, ir_f16_gpa))
```


```{r}
colSums(is.na(expdata))
```


```{r}
instructorrace <- expdata %>%
  dplyr::select(teacherid,
         t1_race_1, t1_race_2, t1_race_3, t1_race_4, t1_race_5, t1_race_6, t1_race_7, t_multi_race) %>%
  unique() %>%
  dplyr::summarize(white = sum(t1_race_1, na.rm = TRUE)/n(),
            black = sum(t1_race_2, na.rm = TRUE)/n(),
            hispanic = sum(t1_race_3, na.rm = TRUE)/n(),
            asian = sum(t1_race_4, na.rm = TRUE)/n(),
            americanindian = sum(t1_race_5, na.rm = TRUE)/n(),
            middleeastern = sum(t1_race_6, na.rm = TRUE)/n(),
            other = sum(t1_race_7, na.rm = TRUE)/n(),
            mixed = sum(t_multi_race > 1, na.rm = TRUE)/n(),
            total = n())
```
```{r}
studentrace <- expdata %>%
  dplyr::select(id,
         s1_race_1, s1_race_2, s1_race_3, s1_race_4, s1_race_5, s1_race_6, s1_race_7, s_multi_race) %>%
  unique() %>%
  dplyr::summarize(white = sum(s1_race_1, na.rm = TRUE)/n(),
            black = sum(s1_race_2, na.rm = TRUE)/n(),
            hispanic = sum(s1_race_3, na.rm = TRUE)/n(),
            asian = sum(s1_race_4, na.rm = TRUE)/n(),
            americanindian = sum(s1_race_5, na.rm = TRUE)/n(),
            middleeastern = sum(s1_race_6, na.rm = TRUE)/n(),
            other = sum(s1_race_7, na.rm = TRUE)/n(),
            mixed = sum(s_multi_race > 1, na.rm = TRUE)/n(),
            total = n())
```



```{r}
expdata %>%
  group_by(treatment) %>%
  summarize(white = sum(s1_race_1, na.rm = TRUE)/n(),
            black = sum(s1_race_2, na.rm = TRUE)/n(),
            hispanic = sum(s1_race_3, na.rm = TRUE)/n(),
            asian = sum(s1_race_4, na.rm = TRUE)/n(),
            americanindian = sum(s1_race_5, na.rm = TRUE)/n(),
            middleeastern = sum(s1_race_6, na.rm = TRUE)/n(),
            other = sum(s1_race_7, na.rm = TRUE)/n(),
            total = n())
```
```{r}
expdata %>%
  group_by(treatment) %>%
  summarize(meanage = mean(s1_age, na.rm = TRUE))
```
```{r}
expdata %>%
  group_by(treatment) %>%
  summarise(prestudentsimilarity = mean(s1_sim, na.rm = TRUE),
            prestudentISR = mean(s1_tsr),
            poststudentsimilarity = mean(s2_sim, na.rm = TRUE),
            poststudentISR = mean(s2_tsr, na.rm = TRUE),
            postinstructorsimilarity = mean(t2_sim1, na.rm = TRUE),
            postinstructorISR = mean(t2_tsr, na.rm = TRUE),
            standardgrade = mean(grade_sd, na.rm = TRUE))
```

```{r}
summary(lm(data = isrdata, s1_sim ~ treatment))
```
```{r}
summary(lm(data = isrdata, s2_sim ~ treatment))
```
```{r}
summary(lm(data = isrdata, s2_tsr ~ treatment + s1_tsr))
```
```{r}
summary(polr(formula = as.factor(t2_sim1) ~ treatment, data = isrdata, Hess = TRUE))
```

```{r}
summary(lm(data = isrdata, s2_tsr ~ treatment))
```

```{r}
summary(lm(data = isrdata, grade ~ treatment + s1_female + ir_f16_gpa))
```

```{r}
summary(lm(data = isrdata %>% filter(obj_exam == 1), t2_finalexam ~ treatment + s1_female + ir_f16_gpa))
```

```{r}
summary(glm(data = isrdata, f17_enrolled ~ treatment + s1_female + ir_f16_gpa, family = "binomial"))
```

```{r studentfirstsimilarity, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(!is.na(s1_sim)) %>%
  finalfit("s1_sim", "treatment") %>%
  knitr::kable(caption = "Effect of treatment on immediate student similarity rating",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r studentsecondsimilarity, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(!is.na(s2_sim)) %>%
  finalfit("s2_sim", "treatment") %>%
  knitr::kable(caption = "Effect of treatment on end of semester student similarity rating",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r studentsecondrelationship, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(!is.na(s2_tsr) & !is.na(s1_tsr)) %>%
  finalfit("s2_tsr", c("treatment", "s1_tsr")) %>%
  knitr::kable(caption = "Effect of treatment on end of semester student ISR rating, controlling for anticipated ISR",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r teachersecondrelationship, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(!is.na(t2_tsr)) %>%
  finalfit("t2_tsr", c("treatment")) %>%
  knitr::kable(caption = "Effect of treatment on end of semester instructor ISR rating",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r grade, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(grade) & s1_female > -99) %>%
  dplyr::select(s1_female, ir_f16_gpa, grade, s1_female, treatment) %>%
  finalfit("grade", c("treatment",  "s1_female", "ir_f16_gpa")) %>%
  knitr::kable(caption = "Effect of treatment on course grade, controlling for student gender and prior GPA",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r examgrade, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(obj_exam == 1) %>%
  filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(t2_finalexam) & s1_female > -99) %>%
  finalfit("t2_finalexam", c("treatment",  "s1_female", "ir_f16_gpa")) %>%
  knitr::kable(caption = "Effect of treatment on objectively graded exam grade, controlling for student gender and prior GPA",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```


```{r teachersecondsimilarity, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  filter(!is.na(t2_sim1)) %>%
  mutate(t2_sim1 = as.factor(t2_sim1)) %>%
  finalfit("t2_sim1", "treatment") %>%
  knitr::kable(caption = "Effect of treatment on end of semester instructor similarity rating",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r enrollmentfall, echo=FALSE, warning=FALSE, message=FALSE}
expdata %>%
  mutate(f17_enrolled = as.factor(f17_enrolled)) %>%
  filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(f17_enrolled) & s1_female > -99) %>%
  finalfit("f17_enrolled", c("treatment",  "s1_female", "ir_f16_gpa")) %>%
  knitr::kable(caption = "Effect of treatment on enrollment in next Fall 2017, controlling for student gender and prior GPA",
               booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "scale_down"))
```

```{r}
expdata %>% filter(!is.na(s1_sim)) %>%
  ggplot(aes(x = s1_sim, fill = treatment)) +
  geom_histogram(position = "dodge")

theirs <- isrdata %>%
  filter(use == 1) %>%
  dplyr::select(teacherid) %>%
  unique()

mine <- expdata %>%
  dplyr::select(teacherid) %>%
  unique()
```

```{r}
expdata %>% filter(!is.na(s2_sim)) %>%
  ggplot(aes(x = s2_sim, fill = treatment)) +
  geom_histogram(position = "dodge")
```

```{r}
expdata %>% filter(!is.na(s2_tsr) & !is.na(s1_tsr)) %>%
  ggplot(aes(x = s2_tsr, fill = treatment)) +
  geom_histogram(position = "dodge")
```

```{r}
expdata %>% filter(!is.na(t2_tsr)) %>%
  ggplot(aes(x = t2_tsr, fill = treatment)) +
  geom_histogram(position = "dodge")
```

```{r}
expdata %>% filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(grade) & s1_female > -99) %>%
  ggplot(aes(x = grade, fill = treatment)) +
  geom_histogram(position = "dodge")
```

```{r}
expdata %>% filter(obj_exam == 1) %>% filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(t2_finalexam) & s1_female > -99) %>%
  ggplot(aes(x = t2_finalexam, fill = treatment)) +
  geom_histogram(position = "dodge")
```

```{r}
expdata %>% filter(!is.na(t2_sim1)) %>%
  ggplot(aes(x = t2_sim1, fill = treatment)) +
  geom_bar(position = "dodge")
```

```{r}
expdata %>% 
  mutate(f17_enrolled = as.factor(f17_enrolled)) %>% 
  filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(f17_enrolled) & s1_female > -99) %>%
  ggplot(aes(x = f17_enrolled, fill = treatment)) +
  geom_bar(position = "dodge")
```



