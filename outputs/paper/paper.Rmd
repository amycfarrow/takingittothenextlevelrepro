---
title: "The inefficacy of superficial similarities for improving instructor-student relationships"
author: "Amy Farrow"
date: "April 13th, 2021"
header-includes:
  \usepackage{dcolumn}
  \usepackage{rotating}
output:
  bookdown::pdf_document2:
    toc: yes
subtitle: "Replicating ‘Taking It to the Next Level’"
abstract: "This paper replicates the 2019 article 'Taking It to the Next Level' [@citeoriginal], which evaluates an intervention to improve college instructor-student relationship. The modeling results indicate that the intervention, consisting of informing instructors and students about commonalities, has a weak positive effect on student perceptions of instructor-student similarity, but no effect on student perceptions of instructor-student relationship, instructor perception of similarity or instructor-student relationship, grades, or re-enrollment. While the scalability and affordability of the intervention are desirable, there are no results in any of the targeted measures: those that affect and reflect college retention. These results are consistent with the original paper. TODO: revise to clearliy indicate my own findings \\par \\textbf{Keywords:} instructor-student relationship, college, replication study"
thanks: 'Code and data are available at: [github.com/amycfarrow/takingittothenextlevelrepro](https://github.com/amycfarrow/takingittothenextlevelrepro).'
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(bookdown)    # for cross referencing figures and graphs; referencing
library(kableExtra)  # for nicer tables
library(here) # for working in an RProject
library(Hmisc) # for correlation matrix
library(readstata13) # for stata files
library(finalfit) # for summary table
library(stargazer) # for model table
library(MASS) # for ordinal logistic model
library(cowplot) # for putting plots side by side

# NOTE: script 01_ must have been run already

apply_if <- function(mat, p, f) {
  # Fill NA with FALSE
  p[is.na(p)] <- FALSE
  mat[p] <- f(mat[p])
  mat
}

apaCorr <- function(mat, corrtype = "pearson") {
  matCorr <- mat
  if (class(matCorr) != "rcorr") {
    matCorr <- rcorr(mat, type = corrtype)
  }

  # Add one star for each p < 0.05, 0.01, 0.001
  stars <- apply_if(round(matCorr$r, 2), matCorr$P < 0.05, function(x) paste0(x, "*"))
  stars <- apply_if(stars, matCorr$P < 0.01, function(x) paste0(x, "*"))
  stars <- apply_if(stars, matCorr$P < 0.001, function(x) paste0(x, "*"))
  # Put - on diagonal and blank on upper diagonal
  stars[upper.tri(stars, diag = T)] <- "-"
  stars[upper.tri(stars, diag = F)] <- ""
  n <- length(stars[1,])
  #colnames(stars) <- 1:n
  # Remove _ and convert to title case
  #row.names(stars) <- tools::toTitleCase(sapply(row.names(stars), gsub, pattern="_", replacement = " "))
  # Add index number to row names
  #row.names(stars) <- paste(paste0(1:n,"."), row.names(stars))
  stars
}
```

# Introduction

College is perceived to be a meritocratic tool for social mobility and career success [@college]. Unfortunately, retention is a large problem in contemporary American colleges, and many students begin degrees without completing them; six-year completion rates for full-time first-time students range from 51% to 86%, depending on school [@finishline]. Even when controlling for pre-college test scores and initial enrollments, completion rate disparities exist based on parental education, socio-economic status, and race/ethnicity [@finishline]. Disparities in college completion lead to further entrenchment of long-standing inequalities [@finishline]. Thus, measures to help students persist in college completion are desirable to reduce wasted resources, and to increase societal equity.

@citeoriginal's paper, "Taking It to the Next Level: A Field Experiment to Improve Instructor-Student Relationships in College", tests an intervention to improve college retention and performance. In this field experiment, they tested the effect of instructor-student similarity on instructor-student relationships (ISRs) and measures of student success. Based on extensive K-12 research about the importance of instructor-student relationship for student success, @citeoriginal aimed to establish how instructor-student relationships could be improved at the college level, and to test if this improvement had a positive result.

TODO: add a bit more about the original experiment.

This paper replicates @citeoriginal's original analysis, using anonymized data provided by the authors. Linear, logistic, and ordinal logistic models are used to predict outcomes including perceived ISR, grade, and re-enrollment. These models show that treatment slightly improves student perception of instructor-student similarity, but does not significantly affect student or instructor ISR perception, grade, exam grade, or future enrollment. In addition to the models in the original paper, this paper explores models using different controls and models that consider specific subgroups of the study participants.

TODO: expand on my own findings.

TODO: clearly outline the structure of the whole paper.

## Literature review

TODO: expand this paragraph about interventions, preferably targeting similar ideas to the @citeoriginal paper. What has worked? Draw attention to results. Make sure to refer to any studies that @citeoriginal say are especially influential for their work.

Many interventions to increase completion rates have been suggested and tested. For example, @citecasemanagement studied case managment techniques; @citerecruiting investigated the effect of high school recruitment; @citenearbies identify the importance of interpersonal relationships; @citecertificate argue that certificates awarded prior to degrees can ameliorate the 'college-completion crisis'. These are only a small sample of the interventions suggested. Implementing an effective program is difficult due to complicated causes of attrition, embedded social inequalities, and expenses.

TODO: write a paragraph about research on why similarity builds relationships (similarity -> relationships)

TODO: write a paragraph about research on why relationships matter for scholastic performance (relationships -> grades)
@Abrami_Mizener_1985's study of college students found a . One study of Taiwanese high school students explored the link between shared education and life values and student performance [@Lai_2015]. While they found a significant, but small, positive relationship between life values and student performance on analytic tests, education values gave mixed results depending on the natures of the education value and the analytic test in question [@Lai_2015].

TODO: write a paragraph about research on why relationships matter for persistence (relationships -> persistence)

# Methodology

@citeoriginal conducted a randomized controlled trial to assess the impact of awareness of instructor-student similarities on perceived similarity, instructor-student relationship, course grade, and re-enrollment.

## Participants

The study took place in the 2017 spring semester at a large Californian University. The study included 120 instructors and their 2,749 students. The instructors participated in the study based on interest and a gift-card incentive, and their students were invited to participate unincentivized.Students were only enrolled in the study for one class, in the event that they were taking classes with multiple participating instructors. TODO: what kind of sampling is this? What are the implications?

## Treatment and control

Participating students were randomly assigned to either treatment or control. At the beginning of the term, all participating students and instructors were given "get to know you" surveys. Using those responses, for each student in the treatment group, seven commonalities were identified between student and instructor (for example, perhaps both student and instructor binge-watch TV to relieve stress, or appreciate loyalty as the most important friend quality), and both student and instructor were informed of these commonalities. They completed a few questions about the similarities and were reminded of them through the semester to ensure they were internalized. Students in the control group were informed about similarities they shared with students in another part of the country, and instructors were told nothing about these students.

## Procedures

All students participated in a survey immediately following the treatment or the placebo. They were surveyed again at the end of the course. Instructors were surveyed only at the end of the course.

## Measures

@citeoriginal identify key measures. Full descriptions of all measures are available in [Appendix A].

Some are extracted from the student survey at the beginning of the term:

  1. Immediately after the treatment or placebo, students answered six questions about their perceived similarity to the instructor, on scales of 1 to 5. These responses were averaged to create a student similarity perception scale. 
  2. Immediately after the treatment or placebo, students answered seven questions about their perception of the instructor-student relationship, on scales of 1 to 5. These responses were averaged to create a student ISR perception scale.
  3. Student gender

Others are extracted from the student survey at the end of the term:

  4. At the end of the semester, students answered the student similarity perception scale questions again.
  5. At the end of the semester, students answered the student ISR perception scale questions again.

Others come from the instructor survey at the end of the term:

  6. Instructor similarity perception: At the end of the semester, instructors answered only one question about similarity with the student, on a scale of 1 to 5.
      - Overall, how similar do you think you and STUDENTNAME are?
  7. Instructor ISR perception scale: At the end of the semester, instructors answered seven questions about their perception of the instructor-student relationship, on scales of 1 to 5. These responses were averaged to create an ISR scale.
  8. Final grade: Instructors were asked to report the student's grade on their final exam, paper, or project.

Finally, some are extracted from the university's internal records:

  9. The final grade that the student received in the course.
  10. The student's final grade, standardized against other grades in the course.
  11. The student's cumulative GPA (CGPA) after the Fall 2016 term.
  12. Persistence: The student's status as of Fall term 2017: not enrolled or enrolled.

TODO: evaluate scales' validity?

# Data

TODO: add all citations for R packages, R, and R markdown
The correlation matrix was made using functions by @apacorrcode.

TODO: note where the data is available and describe the dataset basics (cases, variables). Cite the dataset correctly, add to .bib

```{r, warning=FALSE, message=FALSE, echo=FALSE}
isrdata <- read.dta13(here("inputs/data/Instructor-Student Relationships Experiment Data_Anonymous.dta"))
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
expdata <- isrdata %>%
  filter(t1_consent == 1 # Only include if instructor consented to first survey
         & t1_complete == 1 # Only included if instructor completed first survey
         & t1_timer_consent_3 > 1 # Only include if instructor read consent
         & s1_consent == 1 # Only include if student consented to first survey
         & s1_timer_consent_3 > 1 # Only include if student read consent
         & s1_fullsurvey == 1 # Only include if the student completed the whole first survey
         & t2_complete == 1 # Only include if the instructor completed the whole second survey
         # The rest of the lines make sure that the survey taker looked at each page for more than three seconds
         & t1_timer_gtky1_3 > 10
         & t1_timer_gtky2_3 > 10
         & t1_timer_gtky3_3 > 10
         & t1_timer_demos1_3 > 10
         & t1_timer_demos2_3 > 10
         & s1_timer_gtky1_3 > 10
         & s1_timer_gtky2_3 > 10
         & s1_timer_gtky3_3 > 10
         & s1_timerpre1_3 > 10
         & s1_timerpre2_3 > 10
         & (s1_timercontrolfeedback_3 > 10 | is.na(s1_timercontrolfeedback_3))
         & (s1_timercontrolresponse_3 > 10 | is.na(s1_timercontrolresponse_3))
         & (s1_timertreatmentfeedba_3 > 10 | is.na(s1_timertreatmentfeedba_3))
         & (s1_timertreatmentrespon_3 > 10 | is.na(s1_timertreatmentrespon_3))
         & s1_timerpost1_3 > 10
         & s1_timerpost2_3 > 10
         & s1_timerdemo1_3 > 10
         & (s2_timer1a_3 > 10 | is.na(s2_timer1a_3))
         & (s2_timer1b_3 > 10 | is.na(s2_timer1b_3))
         & (s2_timer2a_3 > 10 | is.na(s2_timer2a_3))
         & (s2_timer3a_3 > 10 | is.na(s2_timer3a_3))
         & (s2_timer3b_3 > 10 | is.na(s2_timer3b_3))
         & (s2_timer3c_3 > 10 | is.na(s2_timer3c_3))
         & (s2_timer4_3 > 10 | is.na(s2_timer4_3))
         & t2_timer > 10
         & t_drop_reasons != "Teacher administered GTKY survey mistakenly at end of semester"
         & t_drop_reasons != "Taught online course"
         & t_drop_reasons != "Administered to only graduate students"
         )

# Alternatively: expdata <- isrdata %>% filter(use == 1) %>% # Select only the cases the original study used.
  
expdata <- expdata %>%
  mutate(across(where(is.numeric), ~na_if(., -99))) %>% # Some NAs are shown as -99. Replace with NA.
  mutate(s_race = as.factor(s_race), # make nominal variables into factors.
         t_race = as.factor(t_race),
         teacherid = as.factor(teacherid),
         f17_enrolled = as.factor(f17_enrolled))
```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# The original coding of race contained errors -- ex. a professor who selected White and Asian in the survey,
# and was marked as Asian for most cases, but white for one random case.
# This remakes the variable t_race, for consistency
expdata <- expdata %>%
  mutate(t1_race_1 = replace_na(as.numeric(t1_race_1), 0),
         t1_race_2 = replace_na(as.numeric(t1_race_2), 0),
         t1_race_3 = replace_na(as.numeric(t1_race_3), 0),
         t1_race_4 = replace_na(as.numeric(t1_race_4), 0),
         t1_race_5 = replace_na(as.numeric(t1_race_5), 0),
         t1_race_6 = replace_na(as.numeric(t1_race_6), 0),
         t1_race_7 = replace_na(as.numeric(t1_race_7), 0)) %>%
  mutate(t_race = ifelse(t1_race_1 + t1_race_2 + t1_race_3 + t1_race_4 + t1_race_5 + t1_race_6 + t1_race_7 > 1, 
                         ifelse(t1_race_1 == 1, ifelse(t1_race_2 == 1 & t1_race_3 != 1 & t1_race_4 != 1 & t1_race_5 != 1 & t1_race_6 != 1,
                                                       "Black and White",
                                                       ifelse(t1_race_2 != 1 & t1_race_3 == 1 & t1_race_4 != 1 & t1_race_5 != 1 & t1_race_6 != 1,
                                                              "White Hispanic", "Other multi")), 
                                ifelse(t1_race_2 == 1 & t1_race_3 == 1, "Black Hispanic", "Other multi")), 
                         ifelse(t1_race_1 + t1_race_2 + t1_race_3 + t1_race_4 + t1_race_5 + t1_race_6 + t1_race_7 < 1, "Unknown",
                                ifelse(t1_race_1 == 1, "White",
                                       ifelse(t1_race_2 == 1, "Black",
                                              ifelse(t1_race_3 == 1, "Hispanic",
                                                     ifelse(t1_race_4, "Asian",
                                                            ifelse(t1_race_5, "American Indian",
                                                                   ifelse(t1_race_6, "Middle Eastern",
                                                                          "Other")))))))))

expdata <- expdata %>%
  mutate(s1_race_1 = replace_na(as.numeric(s1_race_1), 0),
         s1_race_2 = replace_na(as.numeric(s1_race_2), 0),
         s1_race_3 = replace_na(as.numeric(s1_race_3), 0),
         s1_race_4 = replace_na(as.numeric(s1_race_4), 0),
         s1_race_5 = replace_na(as.numeric(s1_race_5), 0),
         s1_race_6 = replace_na(as.numeric(s1_race_6), 0),
         s1_race_7 = replace_na(as.numeric(s1_race_7), 0)) %>%
  mutate(s_race = ifelse(s1_race_1 + s1_race_2 + s1_race_3 + s1_race_4 + s1_race_5 + s1_race_6 + s1_race_7 > 1,
                         ifelse(s1_race_1 == 1, ifelse(s1_race_2 == 1 & s1_race_3 != 1 & s1_race_4 != 1 & s1_race_5 != 1 & s1_race_6 != 1,
                                                       "Black and White",
                                                       ifelse(s1_race_2 != 1 & s1_race_3 == 1 & s1_race_4 != 1 & s1_race_5 != 1 & s1_race_6 != 1,
                                                              "White Hispanic", "Other multi")), 
                                ifelse(s1_race_2 == 1 & s1_race_3 == 1, "Black Hispanic", "Other multi")), 
                         ifelse(s1_race_1 + s1_race_2 + s1_race_3 + s1_race_4 + s1_race_5 + s1_race_6 + s1_race_7 < 1, "Unknown",
                                ifelse(s1_race_1 == 1, "White",
                                       ifelse(s1_race_2 == 1, "Black",
                                              ifelse(s1_race_3 == 1, "Hispanic",
                                                     ifelse(s1_race_4, "Asian",
                                                            ifelse(s1_race_5, "American Indian",
                                                                   ifelse(s1_race_6, "Middle Eastern",
                                                                          "Other")))))))))
```

## Demographics

Table \@ref(tab:demotable1) shows the student covariates for the treatment and control samples. There are no significant differences between the treatment and control groups.

Table \@ref(tab:demotable2) shows the instructor covariates. Because instructors are counted multiple times, for each student in the treatment and control groups that is in their course, only the totals are shown. The same covariates, presented by treatment and control groups, are shown in [Appendix B].

There are differences between the students and instructors. Notably, the student sample is 60.3% female, while the instructor sample is 77.5% female. The student sample is 18.6% White, while the instructor sample is 39.2% White. The student sample is 43.5% Hispanic, while the instructor sample is only 3.3%. Finally, the student sample is 9.1% multiracial, but the instructor sample is 51.7% multiracial. Some of these differences may be due to self-identification: while one person who is Hispanic may select only Hispanic, another may select, for example, Hispanic as well as White, and be classed as multiracial. For this reason, it is very difficult to draw conclusions.

Table \@ref(tab:demotable2) shows the continuous covariates for the treatment and control samples. There are no significant differences between the treatment and control groups.

```{r demotable1, echo=FALSE, warning=FALSE, message=FALSE}
# Make a summary table of nominal variables, by treatment group.
demotab <- expdata %>% 
  dplyr::select(treatment, 
                s_female, 
                s_race, 
                s_firstgen,
                s1_age,
                ir_f16_gpa,
                year) %>%
  mutate(year = as.factor(year)) %>%
  mutate(treatment = ff_label(treatment, "Group"),
         s_female = ff_label(s_female, "Student gender"), 
         s1_age = ff_label(s1_age, "Student age"),
         s_race = ff_label(s_race, "Student race"), 
         ir_f16_gpa = ff_label(ir_f16_gpa, "CPGA"),
         s_firstgen = ff_label(s_firstgen, "Student first-gen status"), 
         year = ff_label(year, "Year")) %>%
  summary_factorlist("treatment", 
                     c("s_female", "s_race", "s_firstgen", "year", "s1_age", "ir_f16_gpa"),
                     p = TRUE, 
                     add_dependent_label = TRUE, 
                     dependent_label_prefix = "",
                     add_col_totals = TRUE,
                     add_row_totals = TRUE,
                     include_row_missing_col = TRUE,
                     col_totals_rowname = "",
                     total_col = TRUE,
                     col_totals_prefix = "N(%) = ") %>%
  rename(N = "Total N", Missing = "Missing N") 

# Replace variables that are encoded with their true meanings
demotab[2:3,4] <- c("Male", "Female")
demotab[16:17,4] <- c("No", "Yes")

# Put it all in a nice table.
demotab %>%
  knitr::kable(caption = "Student covariates for treatment and control groups",
               booktabs = TRUE, linesep = "",
               ) %>%
  column_spec(5, width = "5em") %>%
  column_spec(6, width = "5em") %>%
  column_spec(7, width = "5em") %>%
  kableExtra::kable_styling(latex_options = c("scale_down", "striped"),
                            stripe_index =c(2:3, 16:17, 22))


```

```{r demotable2, echo=FALSE, warning=FALSE, message=FALSE}
# make a summary table of continuous variables
demotab2 <- expdata %>% 
  mutate(teacherid = ifelse(as.numeric(teacherid) > 50, "0", "1")) %>%
  dplyr::select(teacherid, t_age, t_firstgen, t_race, t_female, n_course) %>%
  unique() %>%
  mutate(t_age = ff_label(t_age, "Instructor age"), 
         t_female = ff_label(t_female, "Instructor gender"),
         t_race = ff_label(t_race, "Instructor race"),
         t_firstgen = ff_label(t_firstgen, "Instructor first-gen status"),
         n_course = ff_label(n_course, "Course size")) %>%
  summary_factorlist("teacherid",
                     c("t_female", "t_race", "t_firstgen", "t_age", "n_course"),
                     p = TRUE, 
                     add_dependent_label = TRUE, 
                     dependent_label_prefix = "",
                     add_row_totals = TRUE,
                     include_row_missing_col = TRUE,
                     col_totals_rowname = "",
                     total_col = TRUE,
                     add_col_totals = TRUE,
                     col_totals_prefix = "N = ") %>%
  rename(N = "Total N", Missing = "Missing N")

demotab2[2:3,4] <- c("Male", "Female")
demotab2[13:14,4] <- c("No", "Yes")

# put in nice table
demotab2 %>%
  dplyr::select(-"0", -"1", -"p") %>%
  knitr::kable(caption = "Teacher covariates",
               booktabs = TRUE, linesep = "",
               col.names = c("", "N", "Missing", "", "")) %>%
  kableExtra::kable_styling(latex_options = c("striped"), 
                            stripe_index =c(2:3, 13:14, 16))
```

In Figure \@ref(fig:racegraph), we can see that more students identified as Hispanic, while more instructors identified as White and multi-racial.

```{r racegraph, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.cap="Bar chart illustrating racial identification proprtions of participants"}
instructorrace <- expdata %>%
  dplyr::select(teacherid,
         t1_race_1, t1_race_2, t1_race_3, t1_race_4, t1_race_5, t1_race_6, t1_race_7, t_multi_race) %>%
  unique() %>%
  dplyr::summarize(white = sum(t1_race_1, na.rm = TRUE)/n(),
            black = sum(t1_race_2, na.rm = TRUE)/n(),
            hispanic = sum(t1_race_3, na.rm = TRUE)/n(),
            asian = sum(t1_race_4, na.rm = TRUE)/n(),
            americanindian = sum(t1_race_5, na.rm = TRUE)/n(),
            middleeastern = sum(t1_race_6, na.rm = TRUE)/n(),
            other = sum(t1_race_7, na.rm = TRUE)/n(),
            mixed = sum(t_multi_race > 1, na.rm = TRUE)/n())
studentrace <- expdata %>%
  dplyr::select(id,
         s1_race_1, s1_race_2, s1_race_3, s1_race_4, s1_race_5, s1_race_6, s1_race_7, s_multi_race) %>%
  unique() %>%
  dplyr::summarize(white = sum(s1_race_1, na.rm = TRUE)/n(),
            black = sum(s1_race_2, na.rm = TRUE)/n(),
            hispanic = sum(s1_race_3, na.rm = TRUE)/n(),
            asian = sum(s1_race_4, na.rm = TRUE)/n(),
            americanindian = sum(s1_race_5, na.rm = TRUE)/n(),
            middleeastern = sum(s1_race_6, na.rm = TRUE)/n(),
            other = sum(s1_race_7, na.rm = TRUE)/n(),
            mixed = sum(s_multi_race > 1, na.rm = TRUE)/n())

bind_cols(as_tibble(cbind(nms = names(instructorrace), t(instructorrace))),
          as_tibble(cbind(nms = names(studentrace), t(studentrace))))%>%
  dplyr::select(-nms...3) %>%
  pivot_longer(!nms...1, names_to = "group", values_to = "portion") %>%
  ggplot() +
  geom_col(aes(x = nms...1, y = as.numeric(portion), fill = group), position = "dodge") +
  scale_x_discrete(labels = c("American Indian", "Asian", "Black", "Hispanic", "Middle Eastern", "Multiple", "Other", "White")) +
  scale_fill_discrete(labels = c("Instructors", "Students")) +
  labs(x = "Self-identified race", y = "Proportion of sample", fill = "Group", title = "Self-identified racial proportions different for instructors and students") +
  theme_minimal()
```

In Figure \@ref(fig:classsizegraph), we can see that most class sizes are between 25 and 50 students, but there are some that are much larger.

```{r classsizegraph, echo=FALSE, warning=FALSE, message=FALSE, fig.width=5, fig.height = 3, fig.cap="Histogram illustrating class sizes"}
expdata %>%
  dplyr::select(teacherid, n_course) %>%
  unique() %>%
  ggplot(aes(x = n_course)) +
  geom_histogram(binwidth = 5) +
  labs(x = "Class size", y = "Frequency", title = "Some class sizes are very large") +
  theme_minimal()
```

## Outcomes of interest

Table \@ref(tab:summarytable) shows summary statistics for key variables identified by @citeoriginal, including missing values.

```{r summarytable, echo=FALSE, warning=FALSE, message=FALSE}
# Summarize key outcome variables by treatment group
sumtable <- expdata %>% 
  dplyr::select(treatment, 
                s1_sim,
                s1_tsr,
                s2_sim,
                s2_tsr,
                t2_sim1,
                t2_tsr, grade,
                std_grade,
                t2_finalexam,
                f17_enrolled) %>%
  mutate(t2_sim1 = as.factor(t2_sim1)) %>%
  mutate(treatment = ff_label(treatment, "Group"), 
         s1_sim = ff_label(s1_sim, "Initial student similarity perception scale"), 
         s1_tsr = ff_label(s1_tsr, "Initial student ISR perception scale"), 
         s2_sim = ff_label(s2_sim, "End-of-term student similarity perception scale"), 
         s2_tsr = ff_label(s2_tsr, "End-of-term student ISR perception scale"), 
         t2_sim1 = ff_label(t2_sim1, "End-of-term instructor similarity perception"), 
         t2_tsr = ff_label(t2_tsr, "End-of-term instructor ISR perception scale"), 
         grade = ff_label(grade, "Course grade"), 
         std_grade = ff_label(std_grade, "Standardized course grade"), 
         t2_finalexam = ff_label(t2_finalexam, "Final grade"), 
         f17_enrolled = ff_label(f17_enrolled, "Persistence")) %>%
  summary_factorlist("treatment",
                     c("s1_sim", "s1_tsr", "s2_sim", "s2_tsr", "t2_sim1", "t2_tsr",
                       "grade", "std_grade", "t2_finalexam", "f17_enrolled"),
                     p = FALSE, 
                     add_dependent_label = TRUE, 
                     dependent_label_prefix = "",
                     add_col_totals = TRUE,
                     add_row_totals = TRUE,
                     include_row_missing_col = TRUE,
                     col_totals_rowname = "",
                     total_col = TRUE,
                     col_totals_prefix = "N(%) = ") %>%
  rename(N = "Total N", Missing = "Missing N") 

# Rename variables for readability
sumtable[,1] <- c("", "Similarity", "ISR", " Similarity", " ISR", "Similarity ", "", "", "", "", "ISR ", "Course grade", "Stand. grade", "Final grade", "Peristence", "")
# replace nominal encodings with true values
sumtable[15,4] <- "No"
sumtable[16,4] <- "Yes"

# put in table.
sumtable %>%
  knitr::kable(caption = "Outcomes of interest for treatment and control groups",
               booktabs = TRUE, linesep = "",
               col.names = c("", "N", "Missing", "", "Control", "Treatment", "Total")) %>%
  pack_rows("Initial student perception", 2, 3) %>%
  pack_rows("End-of-term student perception", 4, 5) %>%
  pack_rows("End-of-term instructor perception", 6, 11) %>%
  pack_rows("Student outcomes", 12, 15) %>%
  kableExtra::kable_styling(latex_options = c("scale_down", "striped"),
                            stripe_index =c(2,4,6,8,10,13:14))
```

Figure \@ref(fig:continuousoutcomes) shows key continuous outcome distributions for both treatment and control. The only visible differences are in the initial student similarity perception and end-of-term student similarity perception.

```{r continuousoutcomes, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6, fig.height= 10, fig.cap="Histograms illustrating continous and ordinal key outcomes"}
s1_simplot <- expdata %>% 
  ggplot(aes(x = s1_sim, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "Initial student similarity", y = "Frequency", fill = "Group") +
  theme_minimal()

s1_tsrplot <- expdata %>% 
  ggplot(aes(x = s1_tsr, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "Initial student ISR", y = "Frequency") +
  theme_minimal()

s2_simplot <- expdata %>% 
  ggplot(aes(x = s2_sim, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "End-of-term student similarity", y = "Frequency") +
  theme_minimal()

s2_tsrplot <- expdata %>% 
  ggplot(aes(x = s2_tsr, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "End-of-term student ISR", y = "Frequency") +
  theme_minimal()

t2_sim1plot <- expdata %>% 
  ggplot(aes(x = t2_sim1, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "End-of-term instructor similarity", y = "Frequency") +
  theme_minimal()

t2_tsrplot <- expdata %>% 
  ggplot(aes(x = t2_tsr, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "End-of-term instructor ISR", y = "Frequency") +
  theme_minimal()

gradeplot <- expdata %>% 
  ggplot(aes(x = grade, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "Course grade", y = "Frequency") +
  theme_minimal()

std_gradeplot <- expdata %>% 
  ggplot(aes(x = std_grade, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "Standardized course grade", y = "Frequency") +
  theme_minimal()

t2_finalexamplot <- expdata %>% 
  ggplot(aes(x = t2_finalexam, fill = treatment)) +
  geom_histogram(position = "dodge") +
  labs(x = "Final grade", y = "Frequency") +
  theme_minimal()

combined <- plot_grid(s1_simplot + theme(legend.position = "none"), s1_tsrplot + theme(legend.position = "none"),
          s2_simplot + theme(legend.position = "none"), s2_tsrplot + theme(legend.position = "none"),
          t2_sim1plot + theme(legend.position = "none"), t2_tsrplot + theme(legend.position = "none"),
          std_gradeplot + theme(legend.position = "none"), t2_finalexamplot + theme(legend.position = "none"),
          ncol = 2)

legend <- get_legend(s1_simplot + 
                       guides(color = guide_legend(nrow = 1)) +
                       theme(legend.position = "bottom"))

title <- ggdraw() + 
  draw_label(
    "Most key outcomes unaffected by treatment",
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 7)
  )

plot_grid(title,
          combined,
          legend,
          ncol = 1,
          rel_heights = c(.1, 2, .1))
```

Replicating @citeoriginal's study, Table \@ref(tab:correlationtable) displays a correlation matrix for the measures that @citeoriginal identified as significant. Some measures, unsurprisingly, are highly correlated: grade and standardized grade, and grade and final exam grade. Others are moderately correlated: student initial perceptions of similarity and instructor-student relationship, student end-of-term perceptions of similarity and instructor-student relationship, and instructor end-of-term perceptions of similarity and instructor-student relationship. These last three pairs could indicate that the similarity perception scales and instructor-student relationship perception scales may not be measuring distinct concepts, or that feelings of similarity and positivity in relationships are strongly associated in the classroom.

```{r correlationtable, echo=FALSE, warning=FALSE, message=FALSE}
# Make the summary stats part of the table
summary <- expdata %>% 
  dplyr::select(treatment, 
                s1_sim, s1_tsr, s2_sim, s2_tsr, t2_sim1, t2_tsr, 
                grade, std_grade, t2_finalexam, ir_f16_gpa, f17_enrolled, 
                s1_female, n_course) %>%
  mutate(treatment = ff_label(treatment, "Group"), 
         s1_sim = ff_label(s1_sim, "Initial student similarity perception scale"), 
         s1_tsr = ff_label(s1_tsr, "Initial student ISR perception scale"), 
         s2_sim = ff_label(s2_sim, "End-of-term student similarity perception scale"), 
         s2_tsr = ff_label(s2_tsr, "End-of-term student ISR perception scale"), 
         t2_sim1 = ff_label(t2_sim1, "End-of-term instructor similarity perception"), 
         t2_tsr = ff_label(t2_tsr, "End-of-term instructor ISR perception scale"), 
         grade = ff_label(grade, "Course grade"), 
         std_grade = ff_label(std_grade, "Standardized course grade"), 
         t2_finalexam = ff_label(t2_finalexam, "Final grade"),
         ir_f16_gpa = ff_label(ir_f16_gpa, "CPGA"),
         f17_enrolled = ff_label(f17_enrolled, "Persistence"),
         ir_f16_gpa = ff_label(ir_f16_gpa, "CPGA"),
         n_course = ff_label(n_course, "Course size")) %>%
  summary_factorlist("treatment", 
                     c("s1_sim", "s1_tsr", "s2_sim", "s2_tsr", "t2_sim1", "t2_tsr", "grade",
                       "std_grade", "t2_finalexam", "ir_f16_gpa", "n_course"),
                     p = FALSE, 
                     add_dependent_label = TRUE, 
                     dependent_label_prefix = "",
                     add_col_totals = FALSE,
                     add_row_totals = TRUE,
                     include_row_missing_col = TRUE,
                     col_totals_rowname = "",
                     total_col = TRUE,
                     col_totals_prefix = "N (%) = ") %>%
  dplyr::select("Total N", "Missing N", "Total")

# Make the correlation matrix part of the table
matrix <- data.frame(apaCorr(as.matrix(expdata %>% 
                  dplyr::select(s1_sim, s1_tsr, s2_sim, s2_tsr, t2_sim1, t2_tsr, grade, std_grade, t2_finalexam, ir_f16_gpa, n_course)))) 

# Combine the summary and correlation tables
table <- summary %>%
  bind_cols(matrix) %>%
  rename("Mean (SD)" = Total, N = "Total N", Missing = "Missing N")

# rename the variables for table readability
rownames(table) <- c("Similarity", "ISR", " Similarity", " ISR", "Similarity ", "ISR ", "Course", "Stand. course", "Final", "CGPA", "Size")

# Put in a table.
table %>%
  kable(caption = "Correlation matrix for continuous and ordinal key variables and outcomes",
        booktabs = TRUE,
        col.names = c("N", "Missing", "Mean (SD)", "Similarity", "ISR", "Similarity","ISR",
                      "Similarity", "ISR", "Course", "Stand. course", "Final", "CGPA", "Size")) %>%
  column_spec(1, width = "8em") %>%
  column_spec(4, width = "4em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(6, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "4em") %>%
  column_spec(9, width = "4em") %>%
  column_spec(10, width = "4em") %>%
  column_spec(11, width = "4em") %>%
  column_spec(12, width = "4em") %>%
  column_spec(13, width = "2.5em") %>%
  column_spec(14, width = "2.5em") %>%
  pack_rows("Initial student perception", 1, 2) %>%
  pack_rows("End-of-term student perception", 3, 4) %>%
  pack_rows("End-of-term instructor perception", 5, 6) %>%
  pack_rows("Grades", 7, 10) %>%
  pack_rows("Course", 11, 11) %>%
  add_header_above(c(" " = 4, "Initial student" = 2, "End-of-term student" = 2,
                     "End-of-term instructor" = 2, "Grades" = 4, "Course" = 1), 
                   align = "l") %>%
  kable_styling(latex_options = c("scale_down"))
```


## Missing data

TODO: any patterns in missing data.

TODO: did attrition follow any particular pattern? Did some types of students stop responding in between the first and second surveys? Non-response.

## Data selection

TODO: what data was excluded and why?

# Models

## Replication models

TODO: why did @citeoriginal pick these? What do I think about the selection?

$treatment_{i}$ is the indicator that treatment was given.

$X_{1i}$ is a vector of student-level covariates (pre-intervention measures included).

$X_{2j}$ is a vector of instructor-level covariates.

$\epsilon_{ij}$ is a clustered residual.

$\beta_{0}$, $beta_{1}$, $\Gamma_{1}$, $\Gamma_{2}$, and $a_{k}$ are coefficients on the resulting models.

### Linear models

Equation \@ref(eq:linmodel) is @citeoriginal's linear model, used for continuous outcomes, which include complete scale outcomes (immediate student similarity rating (s1_sim), end of semester student similarity rating (s2_sim), end of semester student ISR rating (s2_tsr), and end of semester instructor ISR rating (t2_tsr)) and grade-based outcomes, measured in GPA (course grade (grade) and objectively graded exam grade (t2_finalexam)).

\begin{equation}
(\#eq:linmodel)
Outcome_{ij} = \beta_{0} + \beta_{1}treatment_{i} + X_{1i}\Gamma_{1} + X_{2j}\Gamma_{2} + \epsilon_{ij}
\end{equation}

### Ordinal logistic models

Equation \@ref(eq:ordlogmodel) is @citeoriginal's ordinal logistic model, used for the ordinal outcome, which is end of semester instructor similarity rating (t2_sim1).

\begin{equation}
(\#eq:ordlogmodel)
prob(outcome_{ij}) = a_{k} + \beta_{1}treatment_{i} + X_{1i}\Gamma_{1} + X_{2j}\Gamma_{2} + \epsilon_{ij} > k
\end{equation}

### Logistic models

Equation \@ref(eq:logmodel) is @citeoriginal's logistic model, used for the binary outcome, which is enrollment in Fall term 2017 (f17_enrolled).

\begin{equation}
(\#eq:logmodel)
prob(outcome_{ij}) = a_{k} + \beta_{1}treatment_{i} + X_{1i}\Gamma_{1} + X_{2j}\Gamma_{2} + \epsilon_{ij} > k
\end{equation}

## Additional models

TODO: additional models. Consider: More covariates (race, first generation, matching gender and race); Models looking at subgroups of the sample (Only those with matching traits, only small classes). Focus on grade as the outcome.

# Results

## Replication results

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Make all replication models
studentfirstsimilaritymodel <- lm(data = expdata %>%
                                    filter(!is.na(s1_sim)),
                                  s1_sim ~ treatment + n_course + teacherid)
studentsecondsimilaritymodel <- lm(data = expdata %>% 
                                     filter(!is.na(s2_sim)),
                                   s2_sim ~ treatment + n_course + teacherid)
studentsecondrelationshipmodel <- lm(data = expdata %>%
                                       filter(!is.na(s2_tsr) & !is.na(s1_tsr)),
                                     s2_tsr ~ treatment + s1_tsr + n_course + teacherid)
teachersecondrelationshipmodel <- lm(data = expdata %>%
                                       filter(!is.na(t2_tsr)),
                                     t2_tsr ~ treatment + n_course + teacherid)
grademodel <- lm(data = expdata %>%
                   filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(grade) & s1_female > -99),
                 grade ~ treatment + s1_female + ir_f16_gpa + n_course + teacherid)
examgrademodel <- lm(data = expdata %>%
                       filter(obj_exam == 1) %>%
                       filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(t2_finalexam) & s1_female > -99),
                     t2_finalexam ~ treatment + s1_female + ir_f16_gpa + n_course + teacherid)
teachersecondsimilarity <- polr(formula = as.factor(t2_sim1) ~ treatment + n_course + teacherid,
                                data = expdata %>%
                                  filter(!is.na(t2_sim1)),
                                Hess = TRUE)
enrollmentfallmodel <- glm(data = expdata %>%
                             filter(!is.na(s1_female) & !is.na(ir_f16_gpa) & !is.na(f17_enrolled) & s1_female > -99),
                           f17_enrolled ~ treatment + s1_female + ir_f16_gpa + n_course + teacherid,
                           family = "binomial")
```

```{r modeltable, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
# Make table to display model results
stargazer(studentfirstsimilaritymodel,
          studentsecondsimilaritymodel,
          studentsecondrelationshipmodel,
          teachersecondrelationshipmodel,
          grademodel,
          examgrademodel,
          teachersecondsimilarity,
          enrollmentfallmodel,
          title = "Model results",
          align = TRUE,
          float.env = "sidewaystable",
          no.space = TRUE,
          omit.stat=c("ser","f"),
          column.sep.width = "-10pt",
          label = "tab:modeltable",
          type = "latex",
          header = FALSE,
          omit = c("teacherid"),
          omit.labels = c("Teacher fixed effect"),
          dep.var.labels = c("Student sim. 1",
                             "Student sim. 2",
                             "Student ISR 2",
                             "Instructor ISR 2",
                             "Course grade",
                             "Final grade",
                             "Instructor sim. 2",
                             "Persistence"),
          covariate.labels = c("Treatment", "Student ISR 1", "Student female", "CGPA", "Course size"))
```

TODO: reread paper & Stata code and ensure I caught all models that they report.

In Table \@ref(tab:modeltable), Model 1 shows a statistically significant relationship between treatment and student initial similarity perception. However, the expected increase is only 0.158 on a scale of 1 to 5. Model 2 shows a statistically significant relationship between treatment and student end-of-semester similarity perception. However, the expected increase is only 0.101 on a scale of 1 to 5.

Model 3 shows no significant relationship between treatment and student end-of-semester ISR perception. However, it does show a significant correlation between anticipated student ISR and student end-of-semester ISR. For every 1 point increase in anticipated ISR on a 1 to 5 scale, the expected increase in end-of-semester ISR is 0.674.

Models 4, 5, 6, 7, and 8 show no significant relationship between treatment and instructor end-of-semester ISR perception, course grade, objectively graded exam grade, instructor perception of similarity at the end of the term, and enrollment in the subsequent semester.

TODO: any problems with the models. General performance.

TODO: clustered residuals (low priority)

## Additional results

TODO: additional results

TODO: Shiny.

# Discussion

TODO: does this study have external validity?

TODO: Inefficacy of weak measures in the face of divergent student/instructor demographics and massive class sizes.

TODO: Who perceives similarity

TODO: What does it mean for relationships and therefore academic success to be built on similarity.

\newpage

# (APPENDIX) Appendix {-} 

# Appendix A

Complete list of key measures

* Initial student survey:
  1. Student similarity perception scale (s1_sim)
      - Overall, how similar to your instructor's values do you think your values are?
      - How similar are your goals for the course and your instructor's goals?
      - In general, how similar do you think your views about the course content and your instructor's are?
      - How much do you think you have in common with your instructor?
      - How similar do you think your personality is compared to your instructor's?
      - Overall, how similar do you think you and your instructor are?
  2. Student ISR perception scale (s1_tsr)
      - How much do you think you will enjoy learning from this instructor?
      - How friendly do you think this instructor will be towards you?
      - How encouraging do you think this instructor will be towards you?
      - If you came back to visit this instructor three years from now, how excited do you think they would be?
      - How motivating do you think you will find this instructor's class?
      - How caring do you think this instructor will be towards you?
      - Overall, how much do you think you will learn from this instructor?
  3. Student gender (s1_female)
* End of term student survey:
  4. Student similarity perception scale (s2_sim)
  5. Student ISR perception scale (s2_tsr)
* End of term instructor survey:
  6. Instructor similarity perception (t2_sim1):
      - Overall, how similar do you think you and STUDENTNAME are?
  7. Instructor ISR perception scale (t2_tsr):
      - How much did you enjoy helping STUDENTNAME learn?
      - How caring was STUDENTNAME towards you?
      - How often did you say something encouraging to STUDENTNAME?
      - How friendly was STUDENTNAME towards you?
      - If this student came back to visit you three years from now, how excited would you be?
      - How motivating did STUDENTNAME find the activities that you plan for class?
      - Overall, how much did STUDENTNAME learn from you?
  8. Final grade (t2_finalexam): Instructors were asked to report the student's grade on their final exam, paper, or project.
* University internal records:
  9. Course grade (grade): The final grade that the student received in the course.
  10. Standardized course grade (std_grade): The student's final grade, standardized against other grades in the course.
  11. CGPA (ir_f16_gpa): The student's cumulative GPA after the Fall 2016 term.
  12. Persistence (f17_enrolled): The student's status as of Fall term 2017: not enrolled or enrolled.

# Appendix B

```{r demotable3, echo=FALSE, warning=FALSE, message=FALSE}
# Make a summary table of nominal variables, by treatment group.
demotab3 <- expdata %>% 
  dplyr::select(treatment, 
                t_female, 
                t_race, 
                t_firstgen,
                t_age,
                n_course) %>%
  mutate(treatment = ff_label(treatment, "Group"),
         t_female = ff_label(t_female, "Teacher gender"), 
         t_age = ff_label(t_age, "Teacher age"),
         t_race = ff_label(t_race, "Teacher race"), 
         t_firstgen = ff_label(t_firstgen, "Teacher first-gen status"), 
         n_course = ff_label(n_course, "Course size")) %>%
  summary_factorlist("treatment", 
                     c("t_female", "t_race", "t_firstgen", "t_age", "n_course"),
                     p = TRUE, 
                     add_dependent_label = TRUE, 
                     dependent_label_prefix = "",
                     add_col_totals = TRUE,
                     add_row_totals = TRUE,
                     include_row_missing_col = TRUE,
                     col_totals_rowname = "",
                     total_col = TRUE,
                     col_totals_prefix = "N(%) = ") %>%
  rename(N = "Total N", Missing = "Missing N") 

# Replace variables that are encoded with their true meanings
demotab3[2:3,4] <- c("Male", "Female")
demotab3[13:14,4] <- c("No", "Yes")

# Put it all in a nice table.
demotab3 %>%
  knitr::kable(caption = "Teacher covariates for treatment and control groups",
               booktabs = TRUE, linesep = "",
               ) %>%
  column_spec(5, width = "5em") %>%
  column_spec(6, width = "5em") %>%
  column_spec(7, width = "5em") %>%
  kableExtra::kable_styling(latex_options = c("scale_down", "striped"),
                            stripe_index =c(2:3, 13:14, 16))


```

\newpage

# References
